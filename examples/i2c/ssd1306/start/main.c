
// gpio readall
// gcc -Wall -o app main.c -lwiringPi -lpthread
// sudo ./app

#include <stdlib.h>
#include <stdio.h>
#include <stdbool.h>
#include <wiringPi.h>
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <wiringPiI2C.h>

void oled_fill(uint8_t data);
void oled_set_cursor(uint8_t x, uint8_t y);
void oled_init(void);
void oled_fill_img(uint8_t img[1024]);
void oled_clear(void);
void oled_display_off(void);
void oled_display_on(void);

//-----------------------------------------------------------------------------
// oled - ssd1306

//-------------------------------------
// config

#define SSD1306_ADDRESS     (0x3C)
#define SSD1306_WIDTH       (128)
#define SSD1306_HEIGHT      (64)
#define SSD1306_ROW_COUNT   (8)
#define SSD1306_COL_COUNT   (128)
#define SSD1306_BUFFER_SZIE (SSD1306_ROW_COUNT * SSD1306_COL_COUNT)

//-------------------------------------
// port

int oled_fb = 0;

bool oled_i2c_init(uint8_t addr)
{
    oled_fb = wiringPiI2CSetup(addr);
    // oled_fb = wiringPiI2CSetupInterface("/dev/i2c-2", addr);

    if (oled_fb < 0)
    {
        printf("i2c init fail, error code: %d\n", oled_fb);
        return false;
    }

    return true;
}

bool oled_write_cmd(uint8_t cmd) { return wiringPiI2CWriteReg8(oled_fb, 0x00, cmd); }

bool oled_write_data(uint8_t dat) { return wiringPiI2CWriteReg8(oled_fb, 0x40, dat); }

//-------------------------------------
// driver

void oled_write_ndata(uint8_t* data, uint16_t len)
{
    uint16_t i;
    for (i = 0; i < len; ++i)
    {
        oled_write_data(data[i]);
    }
}

void oled_init(void)
{
    oled_write_cmd(0xAE);  // display off
    oled_write_cmd(0x20);  // Set Memory Addressing Mode
    oled_write_cmd(0x10);  // 00,Horizontal Addressing Mode;01,Vertical Addressing Mode;10,Page Addressing Mode (RESET);11,Invalid
    oled_write_cmd(0xb0);  // Set Page Start Address for Page Addressing Mode,0-7
    oled_write_cmd(0xc8);  // Set COM Output Scan Direction
    oled_write_cmd(0x00);  // set low column address
    oled_write_cmd(0x10);  // set high column address
    oled_write_cmd(0x40);  // set start line address
    oled_write_cmd(0x81);  // set contrast control register
    oled_write_cmd(0xff);
    oled_write_cmd(0xa1);  // set segment re-map 0 to 127
    oled_write_cmd(0xa6);  // set normal display
    oled_write_cmd(0xa8);  // set multiplex ratio(1 to 64)
    oled_write_cmd(0x3F);
    oled_write_cmd(0xa4);  // 0xa4,Output follows RAM content;0xa5,Output ignores RAM content
    oled_write_cmd(0xd3);  // -set display offset
    oled_write_cmd(0x00);  // -not offset
    oled_write_cmd(0xd5);  // set display clock divide ratio/oscillator frequency
    oled_write_cmd(0xf0);  // set divide ratio
    oled_write_cmd(0xd9);  // set pre-charge period
    oled_write_cmd(0x22);  //
    oled_write_cmd(0xda);  // set com pins hardware configuration
    oled_write_cmd(0x12);
    oled_write_cmd(0xdb);  // set vcomh
    oled_write_cmd(0x20);  // 0x20,0.77xVcc
    oled_write_cmd(0x8d);  // set DC-DC enable
    oled_write_cmd(0x14);
    oled_write_cmd(0xaf);  // turn on SSD1306 panel
}

void oled_set_cursor(uint8_t x, uint8_t y)
{
    oled_write_cmd(0xb0 + y);
    oled_write_cmd(((x & 0xf0) >> 4) | 0x10);
    oled_write_cmd(x & 0x0f);
}

void oled_display_on(void)
{
    oled_write_cmd(0X8D);
    oled_write_cmd(0X14);
    oled_write_cmd(0XAF);
}

void oled_display_off(void)
{
    oled_write_cmd(0X8D);
    oled_write_cmd(0X10);
    oled_write_cmd(0XAE);
}

void oled_fill_img(uint8_t img[1024])
{
    oled_set_cursor(0, 0);
    oled_write_ndata(img, 1024);
}

void oled_fill(uint8_t data)
{
    static uint8_t zerobuff[128] = {0x00};

    uint8_t y;

    for (y = 0; y < 128; ++y)
    {
        zerobuff[y] = data;
    }
    for (y = 0; y < 8; ++y)
    {
        oled_set_cursor(0, y);
        oled_write_ndata((uint8_t*)zerobuff, 128);
    }
}

void oled_clear(void)
{
    oled_fill(0x00);
}

//-----------------------------------------------------------------------------
// oled-test

uint8_t img_cxk[] = {
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
    0x1f, 0xf, 0x7, 0x7, 0x3, 0x7, 0xf, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf, 0x3, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0x1,
    0x3, 0x3, 0x3, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0x1f, 0x1f, 0x3f, 0x3f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0x3, 0x0, 0x0, 0x1, 0x1, 0x1, 0x3,
    0xc3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xf8, 0xf0, 0xc0, 0x80, 0x0, 0x0, 0x0, 0x0,
    0x1, 0x3, 0x7, 0xf, 0x1f, 0x3f, 0x3f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xfe, 0xf8, 0xe0, 0x0, 0x0, 0x0, 0xe0, 0xf0, 0xf8, 0xfc, 0xc4, 0xc4, 0xe6, 0xee, 0xce, 0xce, 0xce, 0xcc,
    0xf8, 0xf0, 0xc0, 0x0, 0x0, 0x0, 0x0, 0xfc, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0x7f, 0x3f, 0x1f, 0xf, 0x7, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc0, 0xf0, 0xfe, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0x1f, 0x1f, 0x3f,
    0x7f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfc, 0xf8,
    0xf0, 0xe0, 0xc0, 0xc0, 0x80, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0x1, 0x3, 0x7, 0x7, 0xf, 0x1f,
    0x3f, 0x7f, 0xff, 0xff, 0xfe, 0xfc, 0xff, 0xff, 0xff, 0xe5, 0xc5, 0x85, 0x90, 0x80, 0x0, 0x4, 0x4,
    0x1, 0xa3, 0xe7, 0xff, 0x7f, 0x3f, 0x38, 0x78, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x1f,
    0x7, 0x7, 0x3, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0xe0, 0xf0, 0xf0, 0xf8, 0xfc, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0x7f, 0x7f, 0x3f, 0x3f, 0x1f, 0x1f, 0xf, 0x7, 0x7, 0x3, 0x3, 0x1f, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xfb, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x80, 0x0, 0x0, 0x1, 0x1, 0x3, 0x3, 0x7, 0x7, 0x7, 0x7, 0xf,
    0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0xf, 0x1e, 0x1c, 0x18, 0x30, 0x30,
    0x20, 0x60, 0x40, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x3, 0x7, 0x7, 0x3, 0x1, 0x1, 0x3, 0x7, 0xc,
    0xc, 0xc, 0x6, 0x6, 0x7, 0x3, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x4, 0x6, 0x7, 0x7, 0x7, 0x3, 0x3, 0x3, 0x1, 0x1,
    0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x80, 0x80,
    0x80, 0xc0, 0xc0, 0xe0, 0xe0, 0xf0, 0xf0, 0xf8, 0xfc, 0xfc, 0xfc, 0xfe, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0xfc, 0xfc, 0xfc, 0xfc, 0xf8,
    0xf8, 0xf8, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0x70, 0x20, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x2, 0x6, 0xe, 0xe, 0x1e, 0x3e, 0x7e, 0xfe, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0x1f, 0xf, 0x7, 0x3, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x80, 0x80, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x38, 0xf8,
    0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0xc0, 0x80, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0x7, 0x7, 0x7,
    0x7, 0xf, 0xf, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x3f, 0x3f, 0x3f, 0x7f, 0x7f, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x7f, 0x7f, 0x3f, 0x1f, 0x1f, 0xf, 0xf, 0x7,
    0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0x80, 0xc0, 0xe0, 0xf0, 0xf8, 0xf8, 0xfc, 0xfe, 0xff, 0xff,
    0xff, 0x3f, 0xf, 0x3, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0xf, 0x1f, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0xfe, 0xfc, 0xfc, 0xfc, 0xf8, 0xf0, 0xe0, 0xe0, 0xe0,
    0xe0, 0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf8, 0xf9, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xc7, 0x83, 0x1, 0x1, 0x0, 0x0, 0x80, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x80, 0xc0, 0xc0,
    0xe0, 0xf8, 0xfc, 0xfc, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0x1f, 0x7, 0x3,
    0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc0, 0xf0, 0xfc, 0xfc, 0xfe, 0xf8, 0x60, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x7, 0x1f, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xf, 0x7, 0x7, 0x7,
    0x1f, 0x1f, 0x3f, 0x7f, 0x3f, 0x3f, 0x7f, 0x7f, 0x7f, 0x7f, 0x3f, 0x3f, 0x3f, 0x7f, 0x3f, 0x3f, 0x1f};

int main()
{
    wiringPiSetup();

    if (oled_i2c_init(SSD1306_ADDRESS))
    {
        oled_init();
        oled_display_on();
        oled_fill_img(img_cxk);
    }

    return 0;
}
